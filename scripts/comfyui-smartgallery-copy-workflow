// ==UserScript==
// @name         ComfyUI SmartGallery: Copy Workflow
// @namespace    http://tampermonkey.net/
// @version      1.0
// @description  Intercepts workflow downloads on local SmartGallery, fetches JSON, and copies to clipboard instead of downloading.
// @author       IMGNR
// @match        http://127.0.0.1:8189/*
// @grant        GM_setClipboard
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    // --- UTILITY: Toast Notification ---
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.textContent = message;
        const bgColor = type === 'success' ? '#2f9e44' : '#e03131';

        toast.style.cssText = `
            position: fixed; bottom: 20px; right: 20px;
            background-color: ${bgColor}; color: white;
            padding: 12px 24px; border-radius: 8px; z-index: 999999;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-size: 14px; font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            pointer-events: none; opacity: 0; transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        `;
        document.body.appendChild(toast);

        requestAnimationFrame(() => {
            toast.style.opacity = '1';
            toast.style.transform = 'translateY(0)';
        });

        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateY(20px)';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // --- MAIN LOGIC ---
    document.addEventListener('click', function(e) {
        // Look for the link containing the workflow URL structure
        const link = e.target.closest('a[href*="/galleryout/workflow/"]');

        if (link) {
            // 1. STOP the normal download
            e.preventDefault();
            e.stopPropagation();

            const url = link.href;

            // 2. Fetch the JSON content directly
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.text(); // Get raw text to preserve exact formatting
                })
                .then(jsonText => {
                    // 3. Copy to Clipboard
                    GM_setClipboard(jsonText);
                    showToast('Workflow JSON copied to clipboard!', 'success');
                })
                .catch(err => {
                    console.error('SmartGallery Script Error:', err);
                    showToast('Failed to fetch workflow data', 'error');
                });
        }
    }, true); // Use capture phase to ensure we catch it before other handlers
})();
